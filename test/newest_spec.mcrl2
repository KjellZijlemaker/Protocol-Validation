sort D = struct up | down | left | right;

act
	move: D;
	brakeON, brakeOFF;
	pressU,unpressU,pressD,unpressD,detectU,undetectU,detectD,undetectD;
	pressU_m,unpressU_m,pressD_m,unpressD_m,detectU_m,undetectU_m,detectD_m,undetectD_m;
	pressU_b,unpressU_b,pressD_b,unpressD_b,detectU_s,undetectU_s,detectD_s,undetectD_s;
	undocked_s,undocked_m,undocked, docked_s, docked_m, docked, pressUndock_b, pressUndock_m, pressUndock;
	detectL_s, detectL_m, detectL, detectR_s, detectR_m, detectR;
	undetectL_s, undetectL_m, undetectL, undetectR_s, undetectR_m, undetectR;
	pressReset_b, pressReset_m, pressReset;

proc

	M0(calibrated: Bool, docked: Bool) = (docked_m.M0(calibrated, true) + undocked_m.M0(calibrated, false) +
										pressReset_m.M0(docked, docked)) +
						(calibrated && docked) -> M10(true, false) <> M(calibrated, docked);
	
	M(calibrated: Bool, docked: Bool) = pressU_m.M1(calibrated, docked) +
										pressD_m.M3(calibrated, docked) +
										(unpressU_m+unpressD_m).M0(calibrated, docked);
	M1(calibrated: Bool, docked: Bool) = undetectU_m.M2(calibrated, docked) + (unpressU_m+detectU_m).M0(calibrated, docked);
	M2(calibrated: Bool, docked: Bool) = (unpressU_m+detectU_m).brakeON.M0(calibrated, docked) + pressD_m.M3(calibrated, docked) + brakeOFF.move(up).M2(calibrated, docked);

	M3(calibrated: Bool, docked: Bool) = undetectD_m.M4(calibrated, docked) + (unpressD_m+detectD_m).M0(calibrated, docked);
	M4(calibrated: Bool, docked: Bool) = (unpressD_m+detectD_m).brakeON.M0(calibrated, docked) + pressU_m.M1(calibrated, docked) + brakeOFF.move(down).M4(calibrated, docked);

	M10(rightmost: Bool, toplimit: Bool) = undocked_m.M0(true, false) +
											%(detectL_m + undetectL_m + undetectR_m).M10(false, toplimit) +
											%detectR_m.M10(true, toplimit) +
											%detectU_m.M10(rightmost, true) + undetectU_m.M10(rightmost, false) +
											(rightmost && toplimit) -> M30(rightmost, toplimit) <>   			% left down
											(rightmost && !toplimit) -> M40 <>  								% up down
											(!rightmost && toplimit) -> M20(rightmost, toplimit) <> delta;  	% left right

	M40 = pressU_m.M41 + pressD_m.M42 + (unpressU_m+unpressD_m).M10(true, false);
	M41 = undetectU_m.M42 + unpressU_m.M10(true, false)+detectU_m.M10(true, true);
	M42 = brakeOFF.move(up).M42 +
			unpressU_m.brakeON.M0(true, false) +
			detectU_m.brakeON.M0(true, true) +
			pressD_m.M43;

	M43 = undetectD_m.M44 + unpressD_m.M10(true, false)+detectD_m.M10(true, false);
	M44 = brakeOFF.move(down).M44 +
			unpressD_m.brakeON.M0(true, false) +
			detectD_m.brakeON.M0(true, false) +
			pressU_m.M41; 

	M20(rightmost: Bool, toplimit: Bool) = pressU_m.M21(rightmost, toplimit) + pressD_m.M23(rightmost, toplimit) + (unpressU_m+unpressD_m).M10(false, true);
	M21(rightmost: Bool, toplimit: Bool) = undetectL_m.M22(rightmost, toplimit) + (unpressU_m+detectL_m).M10(false, true);
	M22(rightmost: Bool, toplimit: Bool) = brakeOFF.move(left).M22(false, true) +
											unpressU_m.M10(rightmost, toplimit) +
											detectL_m.brakeON.M10(rightmost, toplimit) +
											pressD_m.M23(rightmost, toplimit);

	M23(rightmost: Bool, toplimit: Bool) = undetectR_m.M24(rightmost, toplimit) + unpressD_m.M10(rightmost, toplimit)+detectR_m.M10(true, toplimit);
	M24(rightmost: Bool, toplimit: Bool) = brakeOFF.move(right).M24(rightmost, toplimit) +
											unpressD_m.brakeON.M10(rightmost, toplimit) +
											detectR_m.brakeON.M10(true, toplimit) +
											pressU_m.M21(rightmost, toplimit);

	M30(rightmost: Bool, toplimit: Bool) = pressD_m.M43 + pressU_m.M21(rightmost, toplimit);


	S = (undetectU_s.detectU_s + undetectD_s.detectD_s +
						undetectL_s.detectL_s + undetectR_s.detectR_s +
						undocked_s.docked_s).S;
	C = (pressU_b.unpressU_b + pressD_b.unpressD_b + pressReset_b).C;

init
	allow({move, detectU, detectD, pressU, pressD, undetectU, undetectD, unpressU, unpressD, brakeON, brakeOFF,
				docked, undocked, pressUndock, pressReset, detectL, detectR, undetectL, undetectR},
		comm(
			{
				pressU_b	|pressU_m -> pressU,
				unpressU_b	|unpressU_m -> unpressU,
				pressD_b	|pressD_m -> pressD,
				unpressD_b	|unpressD_m -> unpressD,
				pressUndock_b	|pressUndock_m -> pressUndock,
				pressReset_b	|pressReset_m -> pressReset,
				
				detectU_s	|detectU_m -> detectU,
				undetectU_s	|undetectU_m -> undetectU,
				detectD_s	|detectD_m -> detectD,
				undetectD_s	|undetectD_m -> undetectD,

				detectL_s	|detectL_m -> detectL,
				undetectL_s	|undetectL_m -> undetectL,
				detectR_s	|detectR_m -> detectR,
				undetectR_s	|undetectR_m -> undetectR,

				undocked_s	|undocked_m -> undocked,
				docked_s	|docked_m -> docked
			},
			M0(false, true) || S || C
		)
	);